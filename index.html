<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cards</title>
  </head>
  <body>
    <svg
      id="play-area"
      width="100vmin"
      height="100vmin"
      xmlns="http://www.w3.org/2000/svg"
      viewBox="-510 -510 1020 1020"
    >
    </svg>
    <script type="module">
      const ranks = [
        "ace",
        "2",
        "3",
        "4",
        "5",
        "6",
        "7",
        "8",
        "9",
        "10",
        "jack",
        "queen",
        "king",
      ];
      const suites = [
        "clubs",
        "diamonds",
        "hearts",
        "spades",
      ];
      const deck = ranks.flatMap((rank) =>
        suites.map((suite) => ({ rank, suite }))
      );
      function shuffle(array) {
        const { length } = array;
        for (let i = 1; i < length; i++) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }
      shuffle(deck);

      /**
       * @param {MouseEvent | TouchEvent} event
       */
      function getMousePosition(event) {
        const CTM = playArea.getScreenCTM();
        const touch = "touches" in event ? event.touches[0] : event;
        return {
          x: (touch.clientX - CTM.e) / CTM.a,
          y: (touch.clientY - CTM.f) / CTM.d,
        };
      }

      /** @type {SVGImageElement | undefined} */
      let selectedCard;

      /** @param {MouseEvent | TouchEvent} event */
      function selectCard(event) {
        selectedCard = event.currentTarget;
      }

      const backHref = "assets/cards/Card_back_01.svg";

      /** @type {SVGSVGElement} */
      const playArea = document.querySelector("#play-area");
      for (const { rank, suite } of deck) {
        const image = document.createElementNS(
          "http://www.w3.org/2000/svg",
          "image",
        );
        const translateTransform = playArea.createSVGTransform();
        translateTransform.setTranslate(0, 0);
        image.transform.baseVal.appendItem(translateTransform);

        image.tabIndex = 0;

        let isRevealed = false;

        const faceHref =
          `assets/cards/standard/English_pattern_${rank}_of_${suite}.svg`;

        image.setAttribute("href", isRevealed ? faceHref : backHref);
        image.setAttribute("x", -50);
        image.setAttribute("y", -75);
        image.setAttribute("width", 100);
        image.setAttribute("height", 150);
        let isDragging = false;
        let offset;
        /** @param {MouseEvent | TouchEvent} event */
        function startDrag(event) {
          isDragging = true;
          offset = getMousePosition(event);
          offset.x -= translateTransform.matrix.e;
          offset.y -= translateTransform.matrix.f;
          if (
            playArea.children[playArea.children.length - 1] !== image
          ) {
            playArea.appendChild(image);
          }
        }
        /** @param {MouseEvent | TouchEvent} event */
        function drag(event) {
          if (!isDragging) return;
          const { x, y } = getMousePosition(event);
          translateTransform.setTranslate(x - offset.x, y - offset.y);
        }
        /** @param {MouseEvent | TouchEvent} event */
        function endDrag(event) {
          isDragging = false;
        }

        image.addEventListener("mousedown", startDrag);
        image.addEventListener("mousemove", drag);
        image.addEventListener("mouseup", endDrag);
        image.addEventListener("touchstart", startDrag);
        image.addEventListener("touchmove", drag);
        image.addEventListener("touchend", endDrag);

        // image.addEventListener("mouseup", selectCard);
        // image.addEventListener("touchend", selectCard);

        image.addEventListener("dblclick", (e) => {
          isRevealed = !isRevealed;
          image.setAttribute("href", isRevealed ? faceHref : backHref);
        });

        let lastTouchTime = -Infinity;
        image.addEventListener("touchstart", (e) => {
          const thisTouchTime = Date.now();
          const interval = thisTouchTime - lastTouchTime;

          if (interval > 0 && interval <= 255) {
            isRevealed = !isRevealed;
            image.setAttribute(
              "href",
              isRevealed ? faceHref : backHref,
            );
          }

          lastTouchTime = thisTouchTime;
        });

        playArea.appendChild(image);
      }
    </script>
  </body>
</html>
